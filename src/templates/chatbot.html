<!DOCTYPE html>
<html lang="en">
<head>
    <!-- Basic HTML document setup with proper encoding and viewport -->
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Health Nutrition Chatbot - Vector Database Search</title>
    
    <!-- Bootstrap CSS for modern, responsive styling -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome for icons -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    
    <!-- Custom CSS for chatbot styling -->
    <style>
        /* Custom styling for the chatbot interface */
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); /* Gradient background */
            min-height: 100vh; /* Full viewport height */
            padding: 20px 0;
        }
        
        .chatbot-container {
            max-width: 800px; /* Maximum width for content */
            margin: 0 auto; /* Center the container */
            background: white;
            border-radius: 15px; /* Rounded corners */
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2); /* Shadow effect */
            overflow: hidden;
        }
        
        .chatbot-header {
            background: linear-gradient(45deg, #4CAF50, #45a049); /* Green gradient */
            color: white;
            padding: 20px;
            text-align: center;
            border-bottom: 3px solid #388e3c;
        }
        
        .header-actions {
            margin-top: 10px;
        }
        
        .chatbot-body {
            padding: 30px; /* Interior padding */
        }
        
        .question-input-section {
            background: #f8f9fa; /* Light gray background */
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 30px;
            border: 2px solid #e9ecef;
        }
        
        .response-section {
            min-height: 200px; /* Minimum height for response area */
            background: #ffffff;
            border-radius: 10px;
            padding: 20px;
            border: 2px solid #dee2e6;
        }
        
        .llm-answer-card {
            background: linear-gradient(45deg, #e8f5e8, #c8e6c9); /* Green gradient */
            border-left: 5px solid #4caf50; /* Green left border */
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            box-shadow: 0 2px 10px rgba(76, 175, 80, 0.1);
        }
        
        .best-answer-card {
            background: linear-gradient(45deg, #e3f2fd, #bbdefb); /* Blue gradient */
            border-left: 5px solid #2196f3; /* Blue left border */
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            box-shadow: 0 2px 10px rgba(33, 150, 243, 0.1);
        }
        
        .match-card {
            background: #f9f9f9; /* Light background */
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 10px;
            transition: transform 0.2s ease; /* Smooth hover effect */
        }
        
        .match-card:hover {
            transform: translateY(-2px); /* Slight lift on hover */
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }
        
        .similarity-badge {
            font-size: 0.8em; /* Smaller font */
            border-radius: 20px; /* Rounded badge */
            padding: 4px 12px;
        }
        
        .similarity-high {
            background-color: #4CAF50; /* Green for high similarity */
            color: white;
        }
        
        .similarity-medium {
            background-color: #FF9800; /* Orange for medium similarity */
            color: white;
        }
        
        .similarity-low {
            background-color: #f44336; /* Red for low similarity */
            color: white;
        }
        
        .loading-spinner {
            display: none; /* Hidden by default */
            text-align: center;
            padding: 20px;
        }
        
        .no-results {
            text-align: center;
            color: #666;
            font-style: italic;
            padding: 40px 20px;
        }
        
        .database-status {
            font-size: 0.9em;
            color: #666;
            margin-top: 10px;
        }
        
        .search-button {
            background: linear-gradient(45deg, #2196f3, #1976d2); /* Blue gradient */
            border: none;
            border-radius: 25px; /* Rounded button */
            padding: 12px 30px;
            color: white;
            font-weight: bold;
            transition: all 0.3s ease;
        }
        
        .search-button:hover {
            transform: translateY(-2px); /* Lift effect on hover */
            box-shadow: 0 6px 20px rgba(33, 150, 243, 0.3);
            background: linear-gradient(45deg, #1976d2, #1565c0);
        }
        
        .search-button:disabled {
            background: #ccc; /* Gray when disabled */
            transform: none;
            box-shadow: none;
        }
        

        
        .question-text {
            font-weight: 500;
            color: #333;
            margin-bottom: 8px;
        }
        
        .answer-text {
            color: #555;
            line-height: 1.6;
        }
        
        .alert-custom {
            border-radius: 10px;
            border: none;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }
    </style>
</head>
<body>
    <div class="chatbot-container">
        <!-- Chatbot Header -->
        <div class="chatbot-header">
            <h1><i class="fas fa-robot"></i> Health Nutrition Chatbot</h1>
            <p class="mb-0">Ask me everything about nutrition, I will provide healthy answers.</p>
            <!-- Database status display -->
            <div class="database-status" id="databaseStatus">
                {% if db_available %}
                    <i class="fas fa-check-circle text-success"></i> 
                    Database connected
                {% else %}
                    <i class="fas fa-exclamation-triangle text-warning"></i> 
                    Database not available - Please use the FAQ Manager first
                {% endif %}
            </div>
            
            <!-- Dataset Selector -->
            <div class="dataset-selector mt-3">
                <div class="row align-items-center justify-content-center">
                    <div class="col-auto">
                        <label for="chatbotDatasetSelect" class="form-label text-light mb-0">
                            <i class="fas fa-layer-group"></i> Dataset:
                        </label>
                    </div>
                    <div class="col-auto">
                        {% if available_datasets %}
                            <div class="input-group input-group-sm">
                                <select class="form-select" id="chatbotDatasetSelect" onchange="switchChatbotDataset()">
                                    {% for dataset in available_datasets %}
                                        <option value="{{ dataset }}" {% if dataset == current_dataset %}selected{% endif %}>
                                            {{ dataset|title }}
                                        </option>
                                    {% endfor %}
                                </select>
                                <button type="button" class="btn btn-outline-light btn-sm" onclick="refreshDatasetList()" title="Refresh dataset list">
                                    <i class="fas fa-sync-alt"></i>
                                </button>
                            </div>
                        {% else %}
                            <div class="input-group input-group-sm">
                                <input type="text" class="form-control form-control-sm" value="None" readonly>
                                <button type="button" class="btn btn-outline-light btn-sm" onclick="refreshDatasetList()" title="Refresh dataset list">
                                    <i class="fas fa-sync-alt"></i>
                                </button>
                            </div>
                        {% endif %}
                    </div>
                    <div class="col-auto">
                        <small class="text-light" id="datasetInfo">
                            Currently: <strong>{{ current_dataset|title if current_dataset else 'None' }}</strong>
                        </small>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Chatbot Body -->
        <div class="chatbot-body">
            <!-- Question Input Section -->
            <div class="question-input-section">
                <h4><i class="fas fa-question-circle"></i> Ask Your Question</h4>
                <p class="text-muted mb-3">Type your question below and I'll search for the most relevant information.</p>
                
                <!-- Question input form -->
                <div class="row">
                    <div class="col-md-9 mb-3">
                        <textarea 
                            id="questionInput" 
                            class="form-control" 
                            rows="3" 
                            placeholder="Enter your question here... For example: 'What are good snacks for diabetics?'"
                        ></textarea>
                    </div>
                    <div class="col-md-3 mb-3 d-flex align-items-center">
                        <button 
                            id="searchButton" 
                            class="search-button w-100"
                            onclick="performSearch()"
                        >
                            <i class="fas fa-search"></i> Ask
                        </button>
                    </div>
                </div>
                
                <!-- Show warning if database not available -->
                <div id="databaseWarning" class="alert alert-warning alert-custom" style="display: none;">
                    <i class="fas fa-info-circle"></i>
                    <strong>Notice:</strong> No dataset selected. 
                    Please create a dataset in the FAQ Manager application first and add some question-answer pairs to enable the chatbot.
                </div>
            </div>
            
            <!-- Response Section -->
            <div class="response-section">
                <h4><i class="fas fa-comments"></i> Response</h4>
                
                <!-- Loading spinner (hidden by default) -->
                <div id="loadingSpinner" class="loading-spinner">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Searching...</span>
                    </div>
                    <p class="mt-3">Searching the nutrition knowledge base...</p>
                </div>
                
                <!-- Initial message when no search has been performed -->
                <div id="initialMessage" class="no-results">
                    <i class="fas fa-lightbulb fa-3x mb-3 text-muted"></i>
                    <p>Ask a question above to get started!</p>
                </div>
                
                <!-- Container for search results -->
                <div id="responseContainer" style="display: none;">
                    <!-- LLM Answer section -->
                    <div id="llmAnswerSection">
                        <h5><i class="fas fa-robot text-success"></i> Answer</h5>
                        <div id="llmAnswerCard" class="llm-answer-card">
                            <div id="llmAnswerText" class="answer-text"></div>
                            <small class="text-muted">
                                <i class="fas fa-brain"></i> 
                                Generated by AI Assistant
                            </small>
                        </div>
                    </div>
                    
                    <!-- Best answer section -->
                    <div id="bestAnswerSection">
                        <h5><i class="fas fa-database text-primary"></i> DB Response</h5>
                        <div id="bestAnswerCard" class="best-answer-card">
                            <div id="bestAnswerText" class="answer-text"></div>
                            <small class="text-muted">
                                <i class="fas fa-chart-line"></i> 
                                Similarity: <span id="bestSimilarity"></span>
                            </small>
                        </div>
                    </div>
                    
                    <!-- Top matches section -->
                    <div id="topMatchesSection">
                        <h5><i class="fas fa-list"></i> Top Related Questions & Answers</h5>
                        <div id="topMatchesContainer">
                            <!-- Dynamic content will be inserted here -->
                        </div>
                        <small class="text-muted">
                            <i class="fas fa-info-circle"></i>
                            <span id="matchesInfo">Showing the top 3 matches</span>
                        </small>
                    </div>
                </div>
                
                <!-- No results message -->
                <div id="noResultsMessage" class="no-results" style="display: none;">
                    <i class="fas fa-search fa-3x mb-3 text-muted"></i>
                    <div class="alert alert-warning alert-custom">
                        <p id="noResultsText" class="mb-0"></p>
                    </div>
                </div>
                
                <!-- Error message display -->
                <div id="errorMessage" class="alert alert-danger alert-custom" style="display: none;">
                    <i class="fas fa-exclamation-triangle"></i>
                    <strong>Error:</strong> <span id="errorText"></span>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Bootstrap JavaScript for interactive components -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    
    <!-- Custom JavaScript for chatbot functionality -->
    <script>


        /**
         * Perform semantic search based on user's question
         * Sends AJAX request to backend and displays results
         */
        function performSearch() {
            // Get the user's question from the input field
            const questionInput = document.getElementById('questionInput');
            const question = questionInput.value.trim();
            
            // Validate that a question was entered
            if (!question) {
                showError('Please enter a question before searching.');
                return;
            }
            
            // Show loading state
            showLoading();
            
            // Send AJAX request to search endpoint
            fetch('/search', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    question: question
                })
            })
            .then(response => response.json()) // Parse JSON response
                            .then(data => {
                // Hide loading spinner
                hideLoading();
                
                if (data.success) {
                    if (data.has_results) {
                        // Display search results (above threshold)
                        displayResults(data);
                    } else if (data.show_top_matches) {
                        // Display no results message but show top matches
                        displayNoResultsWithMatches(data);
                    } else {
                        // Display no results message
                        displayNoResults(data.message, data.user_question);
                    }
                } else {
                    // Display error message
                    showError(data.message);
                }
            })
            .catch(error => {
                // Handle network or other errors
                console.error('Error:', error);
                hideLoading();
                showError('Network error occurred. Please try again.');
            });
        }
        
        /**
         * Display search results in the response section
         * 
         * @param {Object} data - Response data from the server
         */
        function displayResults(data) {
            // Hide other sections
            document.getElementById('initialMessage').style.display = 'none';
            document.getElementById('noResultsMessage').style.display = 'none';
            document.getElementById('errorMessage').style.display = 'none';
            
            // Show response container
            document.getElementById('responseContainer').style.display = 'block';
            
            // Display LLM answer (always shown)
            document.getElementById('llmAnswerText').textContent = data.llm_answer || 'No answer available';
            document.getElementById('llmAnswerSection').style.display = 'block';
            
            // Display best answer from database
            document.getElementById('bestAnswerText').textContent = data.best_answer;
            document.getElementById('bestSimilarity').textContent = data.best_similarity;
            
            // Display top matches
            const topMatchesContainer = document.getElementById('topMatchesContainer');
            topMatchesContainer.innerHTML = ''; // Clear previous results
            
            // Create cards for each top match
            const threshold = Number(data.threshold_used ?? 0.75);
            data.top_matches.forEach((match, index) => {
                const matchCard = document.createElement('div');
                matchCard.className = 'match-card';
                
                // Determine similarity badge color based on score
                let badgeClass = 'similarity-low';
                if (match.similarity >= threshold) {
                    badgeClass = 'similarity-high';
                } else if (match.similarity >= 0.5) {
                    badgeClass = 'similarity-medium';
                }
                
                // Create match card HTML
                matchCard.innerHTML = `
                    <div class="d-flex justify-content-between align-items-start mb-2">
                        <div class="question-text">${index + 1}. ${match.question}</div>
                        <span class="similarity-badge ${badgeClass}">${match.similarity}</span>
                    </div>
                    <div class="answer-text">${match.answer}</div>
                `;
                
                topMatchesContainer.appendChild(matchCard);
            });
            
            // Update matches info text - always show available matches up to 3
            const matchesInfo = document.getElementById('matchesInfo');
            const numMatches = data.top_matches ? data.top_matches.length : 0;
            if (numMatches === 1) {
                matchesInfo.textContent = 'Showing 1 related question';
            } else if (numMatches === 2) {
                matchesInfo.textContent = 'Showing 2 related questions';
            } else if (numMatches === 3) {
                matchesInfo.textContent = 'Showing top 3 related questions';
            } else {
                matchesInfo.textContent = `Showing ${numMatches} related questions`;
            }
        }
        
        /**
         * Display message when no results are found above threshold
         * 
         * @param {string} message - Message to display
         * @param {string} userQuestion - User's original question
         */
        function displayNoResults(message, userQuestion) {
            // Hide other sections
            document.getElementById('initialMessage').style.display = 'none';
            document.getElementById('responseContainer').style.display = 'none';
            document.getElementById('errorMessage').style.display = 'none';
            
            // Show no results message
            document.getElementById('noResultsMessage').style.display = 'block';
            document.getElementById('noResultsText').textContent = message;
        }
        
        /**
         * Display no results message but show top 3 matches anyway
         * 
         * @param {Object} data - Response data from the server
         */
        function displayNoResultsWithMatches(data) {
            // Hide other sections
            document.getElementById('initialMessage').style.display = 'none';
            document.getElementById('noResultsMessage').style.display = 'none';
            document.getElementById('errorMessage').style.display = 'none';
            
            // Show response container
            document.getElementById('responseContainer').style.display = 'block';
            
            // Display LLM answer (always shown)
            document.getElementById('llmAnswerText').textContent = data.llm_answer || 'No answer available';
            document.getElementById('llmAnswerSection').style.display = 'block';
            
            // Hide best answer section since no results above threshold
            document.getElementById('bestAnswerSection').style.display = 'none';
            
            // Show top matches section with "no results" message
            document.getElementById('topMatchesSection').style.display = 'block';
            
            // Add the "no results" message at the top
            const topMatchesContainer = document.getElementById('topMatchesContainer');
            topMatchesContainer.innerHTML = ''; // Clear previous results
            
            // Add no results message
            const noResultsDiv = document.createElement('div');
            noResultsDiv.className = 'alert alert-warning alert-custom mb-3';
            noResultsDiv.innerHTML = `<p class="mb-0">${data.message}</p>`;
            topMatchesContainer.appendChild(noResultsDiv);
            
            // Create cards for each top match
            const threshold = Number(data.threshold_used ?? 0.7);
            data.top_matches.forEach((match, index) => {
                const matchCard = document.createElement('div');
                matchCard.className = 'match-card';
                
                // Determine similarity badge color based on score
                let badgeClass = 'similarity-low';
                if (match.similarity >= threshold) {
                    badgeClass = 'similarity-high';
                } else if (match.similarity >= 0.5) {
                    badgeClass = 'similarity-medium';
                }
                
                // Create match card HTML
                matchCard.innerHTML = `
                    <div class="d-flex justify-content-between align-items-start mb-2">
                        <div class="question-text">${index + 1}. ${match.question}</div>
                        <span class="similarity-badge ${badgeClass}">${match.similarity}</span>
                    </div>
                    <div class="answer-text">${match.answer}</div>
                `;
                
                topMatchesContainer.appendChild(matchCard);
            });
            
            // Update matches info text - always show available matches up to 3
            const matchesInfo = document.getElementById('matchesInfo');
            const numMatches = data.top_matches ? data.top_matches.length : 0;
            if (numMatches === 1) {
                matchesInfo.textContent = 'Showing 1 related question';
            } else if (numMatches === 2) {
                matchesInfo.textContent = 'Showing 2 related questions';
            } else if (numMatches === 3) {
                matchesInfo.textContent = 'Showing top 3 related questions';
            } else {
                matchesInfo.textContent = `Showing ${numMatches} related questions`;
            }
        }
        
        /**
         * Display error message
         * 
         * @param {string} message - Error message to display
         */
        function showError(message) {
            // Hide other sections
            document.getElementById('initialMessage').style.display = 'none';
            document.getElementById('responseContainer').style.display = 'none';
            document.getElementById('noResultsMessage').style.display = 'none';
            
            // Show error message
            document.getElementById('errorMessage').style.display = 'block';
            document.getElementById('errorText').textContent = message;
        }
        
        /**
         * Show loading spinner and disable search button
         */
        function showLoading() {
            // Hide other sections
            document.getElementById('initialMessage').style.display = 'none';
            document.getElementById('responseContainer').style.display = 'none';
            document.getElementById('noResultsMessage').style.display = 'none';
            document.getElementById('errorMessage').style.display = 'none';
            
            // Show loading spinner
            document.getElementById('loadingSpinner').style.display = 'block';
            
            // Disable search button
            const searchButton = document.getElementById('searchButton');
            searchButton.disabled = true;
            searchButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Asking...';
        }
        
        /**
         * Hide loading spinner and re-enable search button
         */
        function hideLoading() {
            // Hide loading spinner
            document.getElementById('loadingSpinner').style.display = 'none';
            
            // Re-enable search button
            const searchButton = document.getElementById('searchButton');
            searchButton.disabled = false;
            searchButton.innerHTML = '<i class="fas fa-search"></i> Ask';
        }
        
        /**
         * Handle Enter key press in question input to trigger search
         */
        document.getElementById('questionInput').addEventListener('keypress', function(event) {
            // Check if Enter key was pressed (without Shift)
            if (event.key === 'Enter' && !event.shiftKey) {
                event.preventDefault(); // Prevent new line
                performSearch(); // Trigger search
            }
        });
        

        
        /**
         * Update UI based on dataset availability
         */
        function updateUIState(hasDataset) {
            const questionInput = document.getElementById('questionInput');
            const searchButton = document.getElementById('searchButton');
            const databaseStatus = document.getElementById('databaseStatus');
            const databaseWarning = document.getElementById('databaseWarning');
            
            if (hasDataset) {
                // Enable UI elements
                questionInput.disabled = false;
                searchButton.disabled = false;
                
                // Update status
                databaseStatus.innerHTML = '<i class="fas fa-check-circle text-success"></i> Database connected';
                databaseWarning.style.display = 'none';
                
                // Focus on input
                questionInput.focus();
            } else {
                // Disable UI elements
                questionInput.disabled = true;
                searchButton.disabled = true;
                
                // Update status
                databaseStatus.innerHTML = '<i class="fas fa-exclamation-triangle text-warning"></i> Database not available - Please use the FAQ Manager first';
                databaseWarning.style.display = 'block';
            }
        }

        /**
         * Switch dataset in chatbot
         */
        function switchChatbotDataset() {
            const datasetSelect = document.getElementById('chatbotDatasetSelect');
            const selectedDataset = datasetSelect.value;
            
            if (!selectedDataset) {
                return;
            }
            
            // Show loading state
            datasetSelect.disabled = true;
            const datasetInfo = document.getElementById('datasetInfo');
            datasetInfo.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Switching...';
            
            // Send AJAX request to switch dataset
            fetch('/switch_dataset', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    dataset_name: selectedDataset
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Update UI with new dataset info
                    datasetInfo.innerHTML = `Currently: <strong>${data.current_dataset.charAt(0).toUpperCase() + data.current_dataset.slice(1)}</strong>`;
                    
                    // Update UI state based on dataset availability
                    const hasActiveDataset = data.current_dataset && data.current_dataset !== null;
                    updateUIState(hasActiveDataset);
                    
                    // Clear any previous search results
                    document.getElementById('initialMessage').style.display = 'block';
                    document.getElementById('responseContainer').style.display = 'none';
                    document.getElementById('noResultsMessage').style.display = 'none';
                    document.getElementById('errorMessage').style.display = 'none';
                    document.getElementById('llmAnswerSection').style.display = 'none';
                    document.getElementById('bestAnswerSection').style.display = 'block';
                    
                    // Clear search input
                    document.getElementById('questionInput').value = '';
                    
                    // Show success message briefly
                    const originalHtml = datasetInfo.innerHTML;
                    datasetInfo.innerHTML = '<i class="fas fa-check text-success"></i> Switched!';
                    setTimeout(() => {
                        datasetInfo.innerHTML = originalHtml;
                    }, 2000);
                    
                } else {
                    // Show error message
                    datasetInfo.innerHTML = '<i class="fas fa-exclamation-triangle text-warning"></i> Switch failed';
                    console.error('Error switching dataset:', data.message);
                    
                    // Reset to previous selection
                    setTimeout(() => {
                        location.reload(); // Reload to reset state
                    }, 2000);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                datasetInfo.innerHTML = '<i class="fas fa-exclamation-triangle text-warning"></i> Network error';
                
                // Reset to previous selection
                setTimeout(() => {
                    location.reload(); // Reload to reset state
                }, 2000);
            })
            .finally(() => {
                datasetSelect.disabled = false;
            });
        }
        
        /**
         * Refresh dataset list
         */
        function refreshDatasetList() {
            const refreshBtn = document.querySelector('button[onclick="refreshDatasetList()"] i');
            refreshBtn.className = 'fas fa-spinner fa-spin';
            
            fetch('/refresh_datasets', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    console.log('Refresh datasets response:', data);
                    
                    // Update dataset info first
                    const datasetInfo = document.getElementById('datasetInfo');
                    const currentDatasetText = data.current_dataset ? data.current_dataset.charAt(0).toUpperCase() + data.current_dataset.slice(1) : 'None';
                    
                    // Update the dataset selector area
                    const selectorContainer = document.getElementById('chatbotDatasetSelect')?.parentElement?.parentElement || 
                                            document.querySelector('input[value="None"]')?.parentElement?.parentElement ||
                                            document.querySelector('.dataset-selector .row .col-auto:nth-child(2)');
                    
                    console.log('Selector container found:', selectorContainer);
                    console.log('Available datasets:', data.available_datasets);
                    console.log('Current dataset:', data.current_dataset);
                    
                    if (data.available_datasets && data.available_datasets.length > 0) {
                        // Create select dropdown
                        selectorContainer.innerHTML = `
                            <div class="input-group input-group-sm">
                                <select class="form-select" id="chatbotDatasetSelect" onchange="switchChatbotDataset()">
                                    ${data.available_datasets.map(dataset => 
                                        `<option value="${dataset}" ${dataset === data.current_dataset ? 'selected' : ''}>${dataset.charAt(0).toUpperCase() + dataset.slice(1)}</option>`
                                    ).join('')}
                                </select>
                                <button type="button" class="btn btn-outline-light btn-sm" onclick="refreshDatasetList()" title="Refresh dataset list">
                                    <i class="fas fa-sync-alt"></i>
                                </button>
                            </div>
                        `;
                    } else {
                        // Show "None" input when no datasets available
                        selectorContainer.innerHTML = `
                            <div class="input-group input-group-sm">
                                <input type="text" class="form-control form-control-sm" value="None" readonly>
                                <button type="button" class="btn btn-outline-light btn-sm" onclick="refreshDatasetList()" title="Refresh dataset list">
                                    <i class="fas fa-sync-alt"></i>
                                </button>
                            </div>
                        `;
                    }
                    
                    // Update dataset info
                    datasetInfo.innerHTML = `Currently: <strong>${currentDatasetText}</strong>`;
                    
                    // Update UI state based on dataset availability
                    const hasActiveDataset = data.current_dataset && data.current_dataset !== null && data.available_datasets && data.available_datasets.length > 0;
                    updateUIState(hasActiveDataset);
                    
                    // Show success feedback
                    const originalHtml = datasetInfo.innerHTML;
                    datasetInfo.innerHTML = '<i class="fas fa-check text-success"></i> Refreshed!';
                    setTimeout(() => {
                        datasetInfo.innerHTML = originalHtml;
                    }, 2000);
                } else {
                    console.error('Error refreshing datasets:', data.message);
                    alert('Error refreshing datasets: ' + data.message);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Network error while refreshing datasets.');
            })
            .finally(() => {
                refreshBtn.className = 'fas fa-sync-alt';
            });
        }
        

        /**
         * Auto-focus on question input when page loads
         */
        document.addEventListener('DOMContentLoaded', function() {
            // Initialize UI state based on current dataset
            const hasDataset = {{ 'true' if current_dataset else 'false' }};
            updateUIState(hasDataset);
        });
    </script>
</body>
</html>
